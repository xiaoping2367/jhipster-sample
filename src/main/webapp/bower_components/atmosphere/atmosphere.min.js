/*
 * Copyright 2014 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * Atmosphere.js
 * https://github.com/Atmosphere/atmosphere-javascript
 * 
 * API reference
 * https://github.com/Atmosphere/atmosphere/wiki/jQuery.atmosphere.js-API
 * 
 * Highly inspired by 
 * - Portal by Donghwan Kim http://flowersinthesand.github.io/portal/
 */
(function(d,p){"function"===typeof define&&define.amd?define(p):d.atmosphere=p()})(this,function(){var d={},p=[],D=[],T=0,W=Object.prototype.hasOwnProperty,d={onError:function(d){},onClose:function(d){},onOpen:function(d){},onReopen:function(d){},onMessage:function(d){},onReconnect:function(d,l){},onMessagePublished:function(d){},onTransportFailure:function(d,l){},onLocalMessage:function(d){},onFailureToReconnect:function(d,l){},onClientTimeout:function(d){},onOpenAfterResume:function(d){},WebsocketApiAdapter:function(g){var l,
f;g.onMessage=function(d){f.onmessage({data:d.responseBody})};g.onMessagePublished=function(d){f.onmessage({data:d.responseBody})};g.onOpen=function(d){f.onopen(d)};f={close:function(){l.close()},send:function(d){l.push(d)},onmessage:function(d){},onopen:function(d){},onclose:function(d){},onerror:function(d){}};l=new d.subscribe(g);return f},AtmosphereRequest:function(g){function l(b,a){return""===e.partialMessage&&"streaming"===a.transport&&b.responseText.length>a.maxStreamingLength?!0:!1}function f(){if(c.enableProtocol&&
!c.firstMessage){var b="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+c.uuid;d.util.each(c.headers,function(a,k){var h=d.util.isFunction(k)?k.call(this,c,c,e):k;null!=h&&(b+="&"+encodeURIComponent(a)+"="+encodeURIComponent(h))});var a=c.url.replace(/([?&])_=[^&]*/,b),a=a+(a===c.url?(/\?/.test(c.url)?"&":"?")+b:""),k={connected:!1},h=new d.AtmosphereRequest(k);h.attachHeadersAsQueryString=!1;h.dropHeaders=!0;h.url=a;h.contentType="text/plain";h.transport="polling";h.method="GET";h.data="";
c.enableXDR&&(h.enableXDR=c.enableXDR);h.async=k.closeAsync;la("",h)}}function m(){"debug"===c.logLevel&&d.util.debug("Closing");E=!0;c.reconnectId&&(clearTimeout(c.reconnectId),delete c.reconnectId);c.heartbeatTimer&&clearTimeout(c.heartbeatTimer);c.reconnect=!1;e.request=c;e.state="unsubscribe";e.responseBody="";e.status=408;e.partialMessage="";v();f();n()}function n(){e.partialMessage="";c.id&&clearTimeout(c.id);c.heartbeatTimer&&clearTimeout(c.heartbeatTimer);null!=z&&(z.close(),z=null);null!=
A&&(A.abort(),A=null);null!=I&&(I.abort(),I=null);null!=s&&(s.canSendMessage&&s.close(),s=null);null!=w&&(w.close(),w=null);null!=B&&(clearInterval(U),document.cookie=Y+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",B.signal("close",{reason:"",heir:E?(B.get("children")||[])[0]:x}),B.close());null!=t&&t.close()}function da(b){n();Z=!0;E=!1;y=0;z=I=w=s=null;c=d.util.extend(c,b);c.mrequest=c.reconnect;c.reconnect||(c.reconnect=!0)}function C(){if(c.shared){t=p(c);if(null!=t&&("debug"===c.logLevel&&
d.util.debug("Storage service available. All communication will be local"),t.open(c)))return;"debug"===c.logLevel&&d.util.debug("No Storage service available.");t=null}c.firstMessage=0==T?!0:!1;c.isOpen=!1;c.ctime=d.util.now();0===c.uuid&&(c.uuid=T);e.closedByClientTimeout=!1;"websocket"!==c.transport&&"sse"!==c.transport?M(c):"websocket"===c.transport?null!=c.webSocketImpl||window.WebSocket||window.MozWebSocket?$(!1):J("Websocket is not supported, using request.fallbackTransport ("+c.fallbackTransport+
")"):"sse"===c.transport&&(window.EventSource?q(!1):J("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+c.fallbackTransport+")"))}function p(b){function a(a,b){var c,d=a.length;for(c=0;c<d;c++)a[c]===b&&a.splice(c,1);return d!==a.length}function k(a){a=d.util.parseJSON(a);var k=a.data;if("c"===a.target)switch(a.type){case "open":r("opening","local",c);break;case "close":X||(X=!0,"aborted"===k.reason?m():k.heir===x?C():setTimeout(function(){C()},100));break;case "message":K(k,
"messageReceived",200,b.transport);break;case "localMessage":ea(k)}}function h(){var a=(new RegExp("(?:^|; )("+encodeURIComponent(f)+")=([^;]*)")).exec(document.cookie);if(a)return d.util.parseJSON(decodeURIComponent(a[2]))}var e,g,X,f="atmosphere-"+b.url,l={storage:function(){function c(a){a.key===f&&a.newValue&&k(a.newValue)}if(d.util.storage){var h=window.localStorage,e=function(a){return d.util.parseJSON(h.getItem(f+"-"+a))};return{init:function(){var a=e("children").concat([x]);h.setItem(f+"-children",
d.util.stringifyJSON(a));d.util.on(window,"storage",c);return e("opened")},signal:function(a,b){h.setItem(f,d.util.stringifyJSON({target:"p",type:a,data:b}))},close:function(){var k=e("children");d.util.off(window,"storage",c);k&&a(k,b.id)&&h.setItem(f+"-children",d.util.stringifyJSON(k))}}}},windowref:function(){var b=window.open("",f.replace(/\W/g,""));if(b&&!b.closed&&b.callbacks)return{init:function(){b.callbacks.push(k);b.children.push(x);return b.opened},signal:function(a,c){!b.closed&&b.fire&&
b.fire(d.util.stringifyJSON({target:"p",type:a,data:c}))},close:function(){X||(a(b.callbacks,k),a(b.children,x))}}}};if((e=h())&&!(1E3<d.util.now()-e.ts)&&(g=l.storage()||l.windowref()))return{open:function(){var a;U=setInterval(function(){var a=e;(e=h())&&a.ts!==e.ts||k(d.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:a.heir}}))},1E3);(a=g.init())&&setTimeout(function(){r("opening","local",b)},50);return a},send:function(a){g.signal("send",a)},localSend:function(a){g.signal("localSend",
d.util.stringifyJSON({id:x,event:a}))},close:function(){E||(clearInterval(U),g.signal("close"),g.close())}}}function ma(){function b(a){a=d.util.parseJSON(a);var b=a.data;if("p"===a.target)switch(a.type){case "send":N(b);break;case "localSend":ea(b);break;case "close":m()}}function a(){document.cookie=Y+"="+encodeURIComponent(d.util.stringifyJSON({ts:d.util.now()+1,heir:(k.get("children")||[])[0]}))+"; path=/"}var k,h="atmosphere-"+c.url,e={storage:function(){function a(c){c.key===h&&c.newValue&&
b(c.newValue)}if(d.util.storage){var c=window.localStorage;return{init:function(){d.util.on(window,"storage",a)},signal:function(a,b){c.setItem(h,d.util.stringifyJSON({target:"c",type:a,data:b}))},get:function(a){return d.util.parseJSON(c.getItem(h+"-"+a))},set:function(a,b){c.setItem(h+"-"+a,d.util.stringifyJSON(b))},close:function(){d.util.off(window,"storage",a);c.removeItem(h);c.removeItem(h+"-opened");c.removeItem(h+"-children")}}}},windowref:function(){var a=h.replace(/\W/g,""),c=document.getElementById(a),
k;c||(c=document.createElement("div"),c.id=a,c.style.display="none",c.innerHTML='<iframe name="'+a+'" />',document.body.appendChild(c));k=c.firstChild.contentWindow;return{init:function(){k.callbacks=[b];k.fire=function(a){var b;for(b=0;b<k.callbacks.length;b++)k.callbacks[b](a)}},signal:function(a,b){!k.closed&&k.fire&&k.fire(d.util.stringifyJSON({target:"c",type:a,data:b}))},get:function(a){return k.closed?null:k[a]},set:function(a,b){k.closed||(k[a]=b)},close:function(){}}}};O=function(a){k.signal("message",
a)};k=e.storage()||e.windowref();k.init();"debug"===c.logLevel&&d.util.debug("Installed StorageService "+k);k.set("children",[]);null==k.get("opened")||k.get("opened")||k.set("opened",!1);Y=encodeURIComponent(h);a();U=setInterval(a,1E3);B=k}function r(b,a,k){c.shared&&"local"!==a&&ma();null!=B&&B.set("opened",!0);k.close=function(){m()};0<y&&"re-connecting"===b?(k.isReopen=!0,na(e)):null==e.error&&(e.request=k,k=e.state,e.state=b,b=e.transport,e.transport=a,a=e.responseBody,v(),e.responseBody=a,e.state=
k,e.transport=b)}function fa(b){b.transport="jsonp";var a=c,k;null!=b&&"undefined"!==typeof b&&(a=b);A={open:function(){function h(){var c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);var d=a.data;a.attachHeadersAsQueryString&&(c=L(a),""!==d&&(c+="&X-Atmosphere-Post-Body="+encodeURIComponent(d)),d="");d=document.head||document.getElementsByTagName("head")[0]||document.documentElement;k=document.createElement("script");k.src=c+"&jsonpTransport="+g;k.clean=function(){k.clean=k.onerror=k.onload=k.onreadystatechange=
null;k.parentNode&&k.parentNode.removeChild(k)};k.onload=k.onreadystatechange=function(){k.readyState&&!/loaded|complete/.test(k.readyState)||k.clean()};k.onerror=function(){k.clean();a.lastIndex=0;a.openId&&clearTimeout(a.openId);a.heartbeatTimer&&clearTimeout(a.heartbeatTimer);a.reconnect&&y++<a.maxReconnectOnClose?(r("re-connecting",a.transport,a),F(A,a,b.reconnectInterval),a.openId=setTimeout(function(){P(a)},a.reconnectInterval+1E3)):u(0,"maxReconnectOnClose reached")};d.insertBefore(k,d.firstChild)}
var g="atmosphere"+ ++x;window[g]=function(b){if(a.reconnect)if(-1===a.maxRequest||a.requestCount++<a.maxRequest){a.executeCallbackBeforeReconnect||F(A,a,a.pollingInterval);if(null!=b&&"string"!==typeof b)try{b=b.message}catch(k){}G(b,a,e)||K(e.responseBody,"messageReceived",200,a.transport);a.executeCallbackBeforeReconnect&&F(A,a,a.pollingInterval)}else d.util.log(c.logLevel,["JSONP reconnect maximum try reached "+c.requestCount]),u(0,"maxRequest reached")};setTimeout(function(){h()},50)},abort:function(){k&&
k.clean&&k.clean()}};A.open()}function oa(b){return null!=c.webSocketImpl?c.webSocketImpl:window.WebSocket?new WebSocket(b):new MozWebSocket(b)}function q(b){e.transport="sse";var a=L(c);"debug"===c.logLevel&&(d.util.debug("Invoking executeSSE"),d.util.debug("Using URL: "+a));if(b&&!c.reconnect)null!=w&&n();else{try{w=new EventSource(a,{withCredentials:c.withCredentials})}catch(k){u(0,k);J("SSE failed. Downgrading to fallback transport and resending");return}0<c.connectTimeout&&(c.id=setTimeout(function(){b||
n()},c.connectTimeout));w.onopen=function(a){H(c);"debug"===c.logLevel&&d.util.debug("SSE successfully opened");c.enableProtocol?c.isReopen&&(c.isReopen=!1,r("re-opening",c.transport,c)):b?r("re-opening","sse",c):r("opening","sse",c);b=!0;"POST"===c.method&&(e.state="messageReceived",w.send(c.data))};w.onmessage=function(a){H(c);!c.enableXDR&&a.origin&&a.origin!==window.location.protocol+"//"+window.location.host?d.util.log(c.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]):
(e.state="messageReceived",e.status=200,a=a.data,G(a,c,e)||(v(),e.responseBody="",e.messages=[]))};w.onerror=function(a){clearTimeout(c.id);c.heartbeatTimer&&clearTimeout(c.heartbeatTimer);e.closedByClientTimeout||((Q(b),n(),E)?d.util.log(c.logLevel,["SSE closed normally"]):b?c.reconnect&&"sse"===e.transport&&(y++<c.maxReconnectOnClose?(r("re-connecting",c.transport,c),0<c.reconnectInterval?c.reconnectId=setTimeout(function(){q(!0)},c.reconnectInterval):q(!0),e.responseBody="",e.messages=[]):(d.util.log(c.logLevel,
["SSE reconnect maximum try reached "+y]),u(0,"maxReconnectOnClose reached"))):J("SSE failed. Downgrading to fallback transport and resending"))}}}function $(b){e.transport="websocket";var a=L(c,d.util.getAbsoluteURL(c.webSocketUrl||c.url)).replace(/^http/,"ws");"debug"===c.logLevel&&(d.util.debug("Invoking executeWebSocket"),d.util.debug("Using URL: "+a));if(b&&!c.reconnect)null!=s&&n();else if(s=oa(a),null!=c.webSocketBinaryType&&(s.binaryType=c.webSocketBinaryType),0<c.connectTimeout&&(c.id=setTimeout(function(){if(!b){s.onclose({code:1002,
reason:"",wasClean:!1});try{n()}catch(a){}}},c.connectTimeout)),s.onopen=function(a){H(c);"debug"===c.logLevel&&d.util.debug("Websocket successfully opened");a=b;null!=s&&(s.canSendMessage=!0);c.enableProtocol||(b=!0,a?r("re-opening","websocket",c):r("opening","websocket",c));null!=s&&"POST"===c.method&&(e.state="messageReceived",s.send(c.data))},s.onmessage=function(a){H(c);c.enableProtocol&&(b=!0);e.state="messageReceived";e.status=200;a=a.data;"string"===typeof a?G(a,c,e)||(v(),e.responseBody=
"",e.messages=[]):(a=ga(c,a),""!==a&&(e.responseBody=a,v(),e.responseBody=null))},s.onerror=function(a){clearTimeout(c.id);c.heartbeatTimer&&clearTimeout(c.heartbeatTimer)},s.onclose=function(a){clearTimeout(c.id);if("closed"!==e.state){var h=a.reason;if(""===h)switch(a.code){case 1E3:h="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:h="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";
break;case 1002:h="The endpoint is terminating the connection due to a protocol error.";break;case 1003:h="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:h="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:h="Unknown: no status code was provided even though one was expected.";break;case 1006:h="Connection was closed abnormally (that is, with no close frame being sent)."}"warn"===
c.logLevel&&(d.util.warn("Websocket closed, reason: "+h),d.util.warn("Websocket closed, wasClean: "+a.wasClean));e.closedByClientTimeout||((Q(b),e.state="closed",E)?d.util.log(c.logLevel,["Websocket closed normally"]):b?c.reconnect&&"websocket"===e.transport&&1001!==a.code&&(n(),y++<c.maxReconnectOnClose?(r("re-connecting",c.transport,c),0<c.reconnectInterval?c.reconnectId=setTimeout(function(){e.responseBody="";e.messages=[];$(!0)},c.reconnectInterval):(e.responseBody="",e.messages=[],$(!0))):(d.util.log(c.logLevel,
["Websocket reconnect maximum try reached "+c.requestCount]),"warn"===c.logLevel&&d.util.warn("Websocket error, reason: "+a.reason),u(0,"maxReconnectOnClose reached"))):J("Websocket failed. Downgrading to Comet and resending"))}},-1<navigator.userAgent.toLowerCase().indexOf("android")&&void 0===s.url)s.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function ga(b,a){var k=a;if("polling"===b.transport)return k;if(0!==d.util.trim(a).length&&b.enableProtocol&&b.firstMessage){var e=
b.trackMessageLength?1:0,g=a.split(b.messageDelimiter);if(g.length<=e+1)return k;b.firstMessage=!1;b.uuid=d.util.trim(g[e]);g.length<=e+2&&d.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]);var f=parseInt(d.util.trim(g[e+1]),10),l=g[e+2];if(!isNaN(f)&&0<f){var m=function(){N(l);b.heartbeatTimer=setTimeout(m,f)};b.heartbeatTimer=setTimeout(m,
f)}"long-polling"!==b.transport&&P(b);T=b.uuid;k="";e=b.trackMessageLength?4:3;if(g.length>e+1)for(;e<g.length;e++)k+=g[e],e+1!==g.length&&(k+=b.messageDelimiter);0!==b.ackInterval&&setTimeout(function(){N("...ACK...")},b.ackInterval)}else b.enableProtocol&&b.firstMessage&&d.util.browser.msie&&10>+d.util.browser.version.split(".")[0]?d.util.log(c.logLevel,["Receiving unexpected data from IE"]):P(b);return k}function H(b){clearTimeout(b.id);0<b.timeout&&"polling"!==b.transport&&(b.id=setTimeout(function(){e.closedByClientTimeout=
!0;e.state="closedByClient";e.responseBody="";e.status=408;e.messages=[];v();f();n()},b.timeout))}function u(b,a){n();clearTimeout(c.id);e.state="error";e.reasonPhrase=a;e.responseBody="";e.status=b;e.messages=[];v()}function G(b,a,c){b=ga(a,b);if(0===b.length)return!0;c.responseBody=b;if(a.trackMessageLength){b=c.partialMessage+b;for(var d=[],e=b.indexOf(a.messageDelimiter);-1!==e;){var g=b.substring(0,e),f=+g;if(isNaN(f))throw Error('message length "'+g+'" is not a number');e+=a.messageDelimiter.length;
e+f>b.length?e=-1:(d.push(b.substring(e,e+f)),b=b.substring(e+f,b.length),e=b.indexOf(a.messageDelimiter))}c.partialMessage=b;if(0!==d.length)c.responseBody=d.join(a.messageDelimiter),c.messages=d;else return c.responseBody="",c.messages=[],!0}else c.responseBody=b;return!1}function J(b){d.util.log(c.logLevel,[b]);if("undefined"!==typeof c.onTransportFailure)c.onTransportFailure(b,c);else if("undefined"!==typeof d.util.onTransportFailure)d.util.onTransportFailure(b,c);c.transport=c.fallbackTransport;
b=-1===c.connectTimeout?0:c.connectTimeout;c.reconnect&&"none"!==c.transport||null==c.transport?(c.method=c.fallbackMethod,e.transport=c.fallbackTransport,c.fallbackTransport="none",0<b?c.reconnectId=setTimeout(function(){C()},b):C()):u(500,"Unable to reconnect with fallback transport")}function L(b,a){var k=c;null!=b&&"undefined"!==typeof b&&(k=b);null==a&&(a=k.url);if(!k.attachHeadersAsQueryString||-1!==a.indexOf("X-Atmosphere-Framework"))return a;a+=-1!==a.indexOf("?")?"&":"?";a+="X-Atmosphere-tracking-id="+
k.uuid;a+="&X-Atmosphere-Framework=2.2.4-javascript";a+="&X-Atmosphere-Transport="+k.transport;k.trackMessageLength&&(a+="&X-Atmosphere-TrackMessageSize=true");null!==k.heartbeat&&null!==k.heartbeat.server&&(a+="&X-Heartbeat-Server="+k.heartbeat.server);""!==k.contentType&&(a+="&Content-Type="+("websocket"===k.transport?k.contentType:encodeURIComponent(k.contentType)));k.enableProtocol&&(a+="&X-atmo-protocol=true");d.util.each(k.headers,function(c,g){var f=d.util.isFunction(g)?g.call(this,k,b,e):
g;null!=f&&(a+="&"+encodeURIComponent(c)+"="+encodeURIComponent(f))});return a}function P(b){b.isOpen?b.isReopen?(b.isReopen=!1,r("re-opening",b.transport,b)):"messageReceived"!==e.state||"jsonp"!==b.transport&&"long-polling"!==b.transport||(b=e,b.state="openAfterResume",aa(b),b.state="messageReceived"):(b.isOpen=!0,r("opening",b.transport,b))}function M(b){var a=c;if(null!=b||"undefined"!==typeof b)a=b;a.lastIndex=0;a.readyState=0;if("jsonp"===a.transport||a.enableXDR&&d.util.checkCORSSupport())fa(a);
else{if(d.util.browser.msie&&10>+d.util.browser.version.split(".")[0]){if("streaming"===a.transport){a.enableXDR&&window.XDomainRequest?R(a):S(a);return}if(a.enableXDR&&window.XDomainRequest){R(a);return}}var g=function(){a.lastIndex=0;a.reconnect&&y++<a.maxReconnectOnClose?(e.ffTryingReconnect=!0,r("re-connecting",b.transport,b),F(h,a,b.reconnectInterval)):u(0,"maxReconnectOnClose reached")};if(a.force||a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)){a.force=!1;var h=d.util.xhr();
h.hasData=!1;W(h,a,!0);a.suspend&&(I=h);"polling"!==a.transport&&(e.transport=a.transport,h.onabort=function(){Q(!0)},h.onerror=function(){e.error=!0;e.ffTryingReconnect=!0;try{e.status=XMLHttpRequest.status}catch(a){e.status=500}e.status||(e.status=500);e.errorHandled||(n(),g())});h.onreadystatechange=function(){if(!E){e.error=null;var f=!1,m=!1;if("streaming"===a.transport&&2<a.readyState&&4===h.readyState)n(),g();else{a.readyState=h.readyState;"streaming"===a.transport&&3<=h.readyState?m=!0:"long-polling"===
a.transport&&4===h.readyState&&(m=!0);H(c);if("polling"!==a.transport){var r=200;4===h.readyState&&(r=1E3<h.status?0:h.status);if(300<=r||0===r){e.errorHandled=!0;n();g();return}a.enableProtocol&&b.firstMessage||2!==h.readyState||(d.util.browser.mozilla&&e.ffTryingReconnect?(e.ffTryingReconnect=!1,setTimeout(function(){e.ffTryingReconnect||P(a)},500)):P(a))}else 4===h.readyState&&(m=!0);if(m)if(m=h.responseText,e.errorHandled=!1,0===d.util.trim(m).length&&"long-polling"===a.transport)h.hasData?h.hasData=
!1:F(h,a,a.pollingInterval);else{h.hasData=!0;ba(h,c);if("streaming"===a.transport)if(d.util.browser.opera)d.util.iterate(function(){if(500!==e.status&&h.responseText.length>a.lastIndex){try{e.status=h.status,e.headers=d.util.parseHeaders(h.getAllResponseHeaders()),ba(h,c)}catch(b){e.status=404}H(c);e.state="messageReceived";var g=h.responseText.substring(a.lastIndex);a.lastIndex=h.responseText.length;(f=G(g,a,e))||v();l(h,a)&&ha(h,a)}else if(400<e.status)return a.lastIndex=h.responseText.length,
!1},0);else{if(r=m.substring(a.lastIndex,m.length),f=G(r,a,e),a.lastIndex=m.length,f)return}else f=G(m,a,e);m=l(h,a);try{e.status=h.status,e.headers=d.util.parseHeaders(h.getAllResponseHeaders()),ba(h,a)}catch(q){e.status=404}e.state=a.suspend?0===e.status?"closed":"messageReceived":"messagePublished";(r=!m&&"streaming"!==b.transport&&"polling"!==b.transport)&&!a.executeCallbackBeforeReconnect&&F(h,a,a.pollingInterval);0===e.responseBody.length||f||v();r&&a.executeCallbackBeforeReconnect&&F(h,a,a.pollingInterval);
m&&ha(h,a)}}}};try{h.send(a.data),Z=!0}catch(f){d.util.log(a.logLevel,["Unable to connect to "+a.url]),u(0,f)}}else"debug"===a.logLevel&&d.util.log(a.logLevel,["Max re-connection reached."]),u(0,"maxRequest reached")}}function ha(b,a){m();E=!1;F(b,a,500)}function W(b,a,g){var h=a.url;null!=a.dispatchUrl&&"POST"===a.method&&(h+=a.dispatchUrl);h=L(a,h);h=d.util.prepareURL(h);g&&(b.open(a.method,h,a.async),0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(n(),K("Connect timeout","closed",
200,a.transport))},a.connectTimeout)));c.withCredentials&&"websocket"!==c.transport&&"withCredentials"in b&&(b.withCredentials=!0);c.dropHeaders||(b.setRequestHeader("X-Atmosphere-Framework",d.util.version),b.setRequestHeader("X-Atmosphere-Transport",a.transport),null!==b.heartbeat&&null!==b.heartbeat.server&&b.setRequestHeader("X-Heartbeat-Server",b.heartbeat.server),a.trackMessageLength&&b.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),b.setRequestHeader("X-Atmosphere-tracking-id",a.uuid),
d.util.each(a.headers,function(c,h){var f=d.util.isFunction(h)?h.call(this,b,a,g,e):h;null!=f&&b.setRequestHeader(c,f)}));""!==a.contentType&&b.setRequestHeader("Content-Type",a.contentType)}function F(b,a,d){if(a.reconnect||a.suspend&&Z){var g=0;b&&1<b.readyState&&(g=1E3<b.status?0:b.status);e.status=0===g?204:g;e.reason=0===g?"Server resumed the connection or down.":"OK";clearTimeout(a.id);a.reconnectId&&(clearTimeout(a.reconnectId),delete a.reconnectId);0<d?c.reconnectId=setTimeout(function(){M(a)},
d):M(a)}}function na(b){b.state="re-connecting";aa(b)}function R(b){"polling"!==b.transport?(z=ia(b),z.open()):ia(b).open()}function ia(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);var g=a.transport,h=0,f=new window.XDomainRequest,l=function(){"long-polling"===a.transport&&a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)&&(f.status=200,R(a))},m=a.rewriteURL||function(a){var b=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(b&&b[1]){case "JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,
";jsessionid="+b[2]+"$1");case "PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+b[2]+"&").replace(/&$/,"")}return a};f.onprogress=function(){clearTimeout(a.id);var b=f.responseText,b=b.substring(h);h+=b.length;if("polling"!==g){H(a);var c=G(b,a,e);if("long-polling"!==g||0!==d.util.trim(b).length)a.executeCallbackBeforeReconnect&&l(),c||K(e.responseBody,"messageReceived",200,g),a.executeCallbackBeforeReconnect||l()}};f.onerror=function(){"polling"!==a.transport&&(n(),y++<a.maxReconnectOnClose?
0<a.reconnectInterval?a.reconnectId=setTimeout(function(){r("re-connecting",b.transport,b);R(a)},a.reconnectInterval):(r("re-connecting",b.transport,b),R(a)):u(0,"maxReconnectOnClose reached"))};f.onload=function(){};return{open:function(){var b=a.url;null!=a.dispatchUrl&&(b+=a.dispatchUrl);b=L(a,b);f.open(a.method,m(b));"GET"===a.method?f.send():f.send(a.data);0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(n(),K("Connect timeout","closed",200,a.transport))},a.connectTimeout))},
close:function(){f.abort()}}}function S(b){z=pa(b);z.open()}function pa(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);var g,h=new window.ActiveXObject("htmlfile");h.open();h.close();var f=a.url;null!=a.dispatchUrl&&(f+=a.dispatchUrl);"polling"!==a.transport&&(e.transport=a.transport);return{open:function(){var b=h.createElement("iframe");f=L(a);""!==a.data&&(f+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data));f=d.util.prepareURL(f);b.src=f;h.body.appendChild(b);var l=b.contentDocument||
b.contentWindow.document;g=d.util.iterate(function(){try{if(l.firstChild){var b=l.body?l.body.lastChild:l,f=function(){var a=b.cloneNode(!0);a.appendChild(l.createTextNode("."));a=a.innerText;return a=a.substring(0,a.length-1)};if(!l.body||!l.body.firstChild||"pre"!==l.body.firstChild.nodeName.toLowerCase()){var m=l.head||l.getElementsByTagName("head")[0]||l.documentElement||l,n=l.createElement("script");n.text="document.write('<plaintext>')";m.insertBefore(n,m.firstChild);m.removeChild(n);b=l.body.lastChild}a.closed&&
(a.isReopen=!0);g=d.util.iterate(function(){var d=f();if(d.length>a.lastIndex){H(c);e.status=200;e.error=null;b.innerText="";if(G(d,a,e))return"";K(e.responseBody,"messageReceived",200,a.transport)}a.lastIndex=0;if("complete"===l.readyState)return Q(!0),r("re-connecting",a.transport,a),0<a.reconnectInterval?a.reconnectId=setTimeout(function(){S(a)},a.reconnectInterval):S(a),!1},null);return!1}}catch(q){return e.error=!0,r("re-connecting",a.transport,a),y++<a.maxReconnectOnClose?0<a.reconnectInterval?
a.reconnectId=setTimeout(function(){S(a)},a.reconnectInterval):S(a):u(0,"maxReconnectOnClose reached"),h.execCommand("Stop"),h.close(),!1}})},close:function(){g&&g();h.execCommand("Stop");Q(!0)}}}function N(b){null!=t?t.send(b):null!=I||null!=w?V(b):null!=z?c.enableXDR&&d.util.checkCORSSupport()?(b=ca(b),b.reconnect=!1,fa(b)):V(b):null!=A?V(b):null!=s?qa(b):(u(0,"No suspended connection available"),d.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before invoking this method"))}
function la(b,a){a||(a=ca(b));a.transport="polling";a.method="GET";a.withCredentials=!1;a.reconnect=!1;a.force=!0;a.suspend=!1;a.timeout=1E3;M(a)}function V(b){b=ca(b);M(b)}function ja(b){var a=b;"object"===typeof a&&(a=b.data);return a}function ca(b){var a=ja(b),a={connected:!1,timeout:6E4,method:"POST",url:c.url,contentType:c.contentType,headers:c.headers,reconnect:!0,callback:null,data:a,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:c.withCredentials,async:c.async,transport:"polling",
isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:c.enableXDR,uuid:c.uuid,dispatchUrl:c.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:c.trackMessageLength,maxReconnectOnClose:c.maxReconnectOnClose,heartbeatTimer:c.heartbeatTimer,heartbeat:c.heartbeat};"object"===typeof b&&(a=d.util.extend(a,b));return a}function qa(b){var a=d.util.isBinary(b)?b:ja(b),e;try{e=null!=c.dispatchUrl?c.webSocketPathDelimiter+c.dispatchUrl+c.webSocketPathDelimiter+a:a,s.canSendMessage?s.send(e):d.util.error("WebSocket not connected.")}catch(g){s.onclose=
function(a){},n(),J("Websocket failed. Downgrading to Comet and resending "+b),V(b)}}function ea(b){b=d.util.parseJSON(b);if(b.id!==x)if("undefined"!==typeof c.onLocalMessage)c.onLocalMessage(b.event);else if("undefined"!==typeof d.util.onLocalMessage)d.util.onLocalMessage(b.event)}function K(b,a,c,d){e.responseBody=b;e.transport=d;e.status=c;e.state=a;v()}function ba(b,a){if(a.readResponsesHeaders)try{var c=b.getResponseHeader("X-Atmosphere-tracking-id");c&&null!=c&&(a.uuid=c.split(" ").pop())}catch(d){}else a.enableProtocol||
(a.uuid=x)}function aa(b){ka(b,c);ka(b,d.util)}function ka(b,a){switch(b.state){case "messageReceived":y=0;if("undefined"!==typeof a.onMessage)a.onMessage(b);if("undefined"!==typeof a.onmessage)a.onmessage(b);break;case "error":if("undefined"!==typeof a.onError)a.onError(b);if("undefined"!==typeof a.onerror)a.onerror(b);break;case "opening":delete c.closed;if("undefined"!==typeof a.onOpen)a.onOpen(b);if("undefined"!==typeof a.onopen)a.onopen(b);break;case "messagePublished":if("undefined"!==typeof a.onMessagePublished)a.onMessagePublished(b);
break;case "re-connecting":if("undefined"!==typeof a.onReconnect)a.onReconnect(c,b);break;case "closedByClient":if("undefined"!==typeof a.onClientTimeout)a.onClientTimeout(c);break;case "re-opening":delete c.closed;if("undefined"!==typeof a.onReopen)a.onReopen(c,b);break;case "fail-to-reconnect":if("undefined"!==typeof a.onFailureToReconnect)a.onFailureToReconnect(c,b);break;case "unsubscribe":case "closed":if("undefined"===typeof c.closed||!c.closed){if("undefined"!==typeof a.onClose)a.onClose(b);
if("undefined"!==typeof a.onclose)a.onclose(b)}c.closed=!0;break;case "openAfterResume":if("undefined"!==typeof a.onOpenAfterResume)a.onOpenAfterResume(c)}}function Q(b){"closed"!==e.state&&(e.state="closed",e.responseBody="",e.messages=[],e.status=b?200:501,v())}function v(){var b=function(a,b){b(e)};null==t&&null!=O&&O(e.responseBody);c.reconnect=c.mrequest;for(var a="string"===typeof e.responseBody,g=a&&c.trackMessageLength?0<e.messages.length?e.messages:[""]:Array(e.responseBody),f=0;f<g.length;f++)if(!(1<
g.length&&0===g[f].length)&&(e.responseBody=a?d.util.trim(g[f]):g[f],null==t&&null!=O&&O(e.responseBody),0!==e.responseBody.length||"messageReceived"!==e.state)){aa(e);if(0<D.length){"debug"===c.logLevel&&d.util.debug("Invoking "+D.length+" global callbacks: "+e.state);try{d.util.each(D,b)}catch(l){d.util.log(c.logLevel,["Callback exception"+l])}}if("function"===typeof c.callback){"debug"===c.logLevel&&d.util.debug("Invoking request callbacks");try{c.callback(e)}catch(m){d.util.log(c.logLevel,["Callback exception"+
m])}}}}var c={timeout:3E5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1E7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,
messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,onError:function(b){},onClose:function(b){},onOpen:function(b){},onMessage:function(b){},onReopen:function(b,a){},onReconnect:function(b,a){},onMessagePublished:function(b){},onTransportFailure:function(b,a){},onLocalMessage:function(b){},onFailureToReconnect:function(b,
a){},onClientTimeout:function(b){},onOpenAfterResume:function(b){}},e={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},s=null,w=null,I=null,z=null,A=null,Z=!0,y=0,E=!1,O=null,B,t=null,x=d.util.now(),U,Y;da(g);this.subscribe=function(b){da(b);C()};this.execute=function(){C()};this.close=function(){m()};this.disconnect=function(){f()};
this.getUrl=function(){return c.url};this.push=function(b,a){if(null!=a){var d=c.dispatchUrl;c.dispatchUrl=a;N(b);c.dispatchUrl=d}else N(b)};this.getUUID=function(){return c.uuid};this.pushLocal=function(b){if(0!==b.length)try{t?t.localSend(b):B&&B.signal("localMessage",d.util.stringifyJSON({id:x,event:b}))}catch(a){d.util.error(a)}};this.enableProtocol=function(b){return c.enableProtocol};this.request=c;this.response=e},subscribe:function(g,l,f){"function"===typeof l&&d.addCallback(l);"string"!==
typeof g?f=g:f.url=g;T="undefined"!==typeof f&&"undefined"!==typeof f.uuid?f.uuid:0;g=new d.AtmosphereRequest(f);g.execute();return p[p.length]=g},unsubscribe:function(){if(0<p.length)for(var d=[].concat(p),l=0;l<d.length;l++){var f=d[l];f.close();clearTimeout(f.response.request.id);f.heartbeatTimer&&clearTimeout(f.heartbeatTimer)}p=[];D=[]},unsubscribeUrl:function(d){var l=-1;if(0<p.length)for(var f=0;f<p.length;f++){var m=p[f];if(m.getUrl()===d){m.close();clearTimeout(m.response.request.id);m.heartbeatTimer&&
clearTimeout(m.heartbeatTimer);l=f;break}}0<=l&&p.splice(l,1)},addCallback:function(g){-1===d.util.inArray(g,D)&&D.push(g)},removeCallback:function(g){g=d.util.inArray(g,D);-1!==g&&D.splice(g,1)},util:{browser:{},parseHeaders:function(d){for(var l,f=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,m={};l=f.exec(d);)m[l[1]]=l[2];return m},now:function(){return(new Date).getTime()},isArray:function(d){return"[object Array]"===Object.prototype.toString.call(d)},inArray:function(d,l){if(!Array.prototype.indexOf){for(var f=
l.length,m=0;m<f;++m)if(l[m]===d)return m;return-1}return l.indexOf(d)},isBinary:function(d){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(d))},isFunction:function(d){return"[object Function]"===Object.prototype.toString.call(d)},getAbsoluteURL:function(d){var l=document.createElement("div");l.innerHTML='<a href="'+d+'"/>';return encodeURI(decodeURI(l.firstChild.href))},prepareURL:function(g){var l=d.util.now(),f=g.replace(/([?&])_=[^&]*/,"$1_="+l);return f+
(f===g?(/\?/.test(g)?"&":"?")+"_="+l:"")},trim:function(d){return String.prototype.trim?d.toString().trim():d.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(g){function l(g,f){f=d.util.isFunction(f)?f():null==f?"":f;n.push(encodeURIComponent(g)+"="+encodeURIComponent(f))}function f(g,m){var n;if(d.util.isArray(m))d.util.each(m,function(d,m){/\[\]$/.test(g)?l(g,m):f(g+"["+("object"===typeof m?d:"")+"]",m)});else if("[object Object]"===Object.prototype.toString.call(m))for(n in m)f(g+
"["+n+"]",m[n]);else l(g,m)}var m,n=[];for(m in g)f(m,g[m]);return n.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(d){return!1}},iterate:function(d,l){var f;l=l||0;(function n(){f=setTimeout(function(){!1!==d()&&n()},l)})();return function(){clearTimeout(f)}},each:function(g,l,f){if(g){var m,n=0,p=g.length;m=d.util.isArray(g);if(f)if(m)for(;n<p&&(m=l.apply(g[n],f),!1!==m);n++);else for(n in g){if(m=l.apply(g[n],f),!1===m)break}else if(m)for(;n<
p&&(m=l.call(g[n],n,g[n]),!1!==m);n++);else for(n in g)if(m=l.call(g[n],n,g[n]),!1===m)break;return g}},extend:function(d){var l,f,m;for(l=1;l<arguments.length;l++)if(null!=(f=arguments[l]))for(m in f)d[m]=f[m];return d},on:function(d,l,f){d.addEventListener?d.addEventListener(l,f,!1):d.attachEvent&&d.attachEvent("on"+l,f)},off:function(d,l,f){d.removeEventListener?d.removeEventListener(l,f,!1):d.detachEvent&&d.detachEvent("on"+l,f)},log:function(d,l){if(window.console){var f=window.console[d];"function"===
typeof f&&f.apply(window.console,l)}},warn:function(){d.util.log("warn",arguments)},info:function(){d.util.log("info",arguments)},debug:function(){d.util.log("debug",arguments)},error:function(){d.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(d){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(l){}}},parseJSON:function(d){return d?window.JSON&&window.JSON.parse?window.JSON.parse(d):(new Function("return "+d))():null},stringifyJSON:function(d){function l(d){return'"'+
d.replace(m,function(d){var f=n[d];return"string"===typeof f?f:"\\u"+("0000"+d.charCodeAt(0).toString(16)).slice(-4)})+'"'}function f(d){return 10>d?"0"+d:d}var m=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(d):function C(d,g){var m,n,p,q=g[d];p=typeof q;q&&"object"===typeof q&&
"function"===typeof q.toJSON&&(q=q.toJSON(d),p=typeof q);switch(p){case "string":return l(q);case "number":return isFinite(q)?String(q):"null";case "boolean":return String(q);case "object":if(!q)return"null";switch(Object.prototype.toString.call(q)){case "[object Date]":return isFinite(q.valueOf())?'"'+q.getUTCFullYear()+"-"+f(q.getUTCMonth()+1)+"-"+f(q.getUTCDate())+"T"+f(q.getUTCHours())+":"+f(q.getUTCMinutes())+":"+f(q.getUTCSeconds())+'Z"':"null";case "[object Array]":n=q.length;p=[];for(m=0;m<
n;m++)p.push(C(m,q)||"null");return"["+p.join(",")+"]";default:p=[];for(m in q)W.call(q,m)&&(n=C(m,q))&&p.push(l(m)+":"+n);return"{"+p.join(",")+"}"}}}("",{"":d})},checkCORSSupport:function(){return d.util.browser.msie&&!window.XDomainRequest&&11>+d.util.browser.version.split(".")[0]||d.util.browser.opera&&12>+d.util.browser.version.split(".")||"KreaTVWebKit/531"===d.util.trim(navigator.userAgent).slice(0,16)||"kreatel"===d.util.trim(navigator.userAgent).slice(-7).toLowerCase()?!0:-1<navigator.userAgent.toLowerCase().indexOf("android")?
!0:!1}}};d.util.now();(function(){var g=navigator.userAgent.toLowerCase(),g=/(chrome)[ \/]([\w.]+)/.exec(g)||/(webkit)[ \/]([\w.]+)/.exec(g)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(g)||/(msie) ([\w.]+)/.exec(g)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(g)||0>g.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(g)||[];d.util.browser[g[1]||""]=!0;d.util.browser.version=g[2]||"0";d.util.browser.trident&&(d.util.browser.msie=!0);if(d.util.browser.msie||d.util.browser.mozilla&&1===+d.util.browser.version.split(".")[0])d.util.storage=
!1})();d.util.on(window,"unload",function(g){d.unsubscribe()});d.util.on(window,"keypress",function(d){(27===d.charCode||27===d.keyCode)&&d.preventDefault&&d.preventDefault()});d.util.on(window,"offline",function(){if(0<p.length)for(var d=[].concat(p),l=0;l<d.length;l++){var f=d[l];f.close();clearTimeout(f.response.request.id);f.heartbeatTimer&&clearTimeout(f.heartbeatTimer)}});d.util.on(window,"online",function(){if(0<p.length)for(var d=0;d<p.length;d++)p[d].execute()});return d});